### Dockerfile notes 
# - The software will create items, therefore needs writable permanent storage under INSTALL_DIR, even with remote database backend
# - Default configuration is changed in the source to omit host specifier where the webserver binds.
#   "localhost" was too restrictive in a Docker container. If you need to change this, you can do it in the config file "mvo.cfg"
# - If you find "file not found" runtime errors, probably some files are missing from the install step 

FROM docker.io/library/alpine:3.20

# OCI Annotations from https://github.com/opencontainers/image-spec/blob/master/annotations.md

LABEL \
org.opencontainers.image.url="TBD"  \
org.opencontainers.image.title="Postgresql backup"          \
org.opencontainers.image.description="Don't forget to mount persistent storage to DATA_DIR, otherwise you will loose data! In order to prevent it, the container refuses to start if it suspects that DATA_DIR is not provided with external persistent storage."


# ARG is gone after build
# ENV will be in the image

ENV TZ="Europe/Brussels"
ENV DATA_DIR="/mnt/postgres-backups"
ENV INSTALL_DIR="/root/scripts"

ENV PGPASSFILE="${INSTALL_DIR}/pgpass.txt"

ENV PGBACKUP_HOSTNAME="localhost"
ENV PGBACKUP_PORT="5432"
ENV PGBACKUP_DATABASE="*"
ENV PGBACKUP_USERNAME="postgres"
ENV PGBACKUP_PASSWORD="dummy"
ENV PGBACKUP_RETENTION_DAYS="30"

ARG RUNTIME_PKGS=" \
            tzdata \
            tini \
            bash \
            nano \
            postgresql16-client \
            "

ARG BUILD_PKGS=" \
             \
            "

# Build and cleanup needs to stay in the same RUN
# otherwise cleanup will run in a separate layer and wont reduce the image size
RUN set -eux && \
    apk update &&\
    apk add \
        --no-cache \
        --clean-protected \
        ${RUNTIME_PKGS} && \
    echo "Installing build dependencies" && \
    apk add \
        --no-cache \
        --clean-protected \
        ${BUILD_PKGS} && \
    mkdir -p "${INSTALL_DIR}" && \
    mkdir -p "${DATA_DIR}" && \
    touch "${DATA_DIR}/NO_PERMANENT_STORAGE" && \
    mkdir -p "/etc/periodic/20min" && \
    echo '*/20    *       *       *       *       run-parts /etc/periodic/20min' >> /etc/crontabs/root && \
    ln -s "${INSTALL_DIR}/pg-dump.sh" "/etc/periodic/20min/pg-dump.sh" && \
    ln -s "${INSTALL_DIR}/pg-dumpall.sh" "/etc/periodic/daily/pg-dumpall.sh" && \
    echo "Container build RUN success" && \
    apk del \
            --no-cache \
            --clean-protected \
        ${BUILD_PKGS} && \
    rm -rf /var/cache/apk/* && \
    rm -rf /root/.cache && \
    echo "Container build cleanup success"

COPY pgpass.txt.example "${INSTALL_DIR}/pgpass.txt.example"
COPY pg-dump.sh "${INSTALL_DIR}/pg-dump.sh"
COPY pg-dumpall.sh "${INSTALL_DIR}/pg-dumpall.sh"

COPY entrypoint.sh /entrypoint.sh


VOLUME [ "${DATA_DIR}" ]

# CMD can be overridden in "docker run", ENTRYPOINT can't be

# Also if you specify both, in normal format it wont work, 
# in array format CMD definition will become argument after ENTRYPOINT
ENTRYPOINT ["/sbin/tini", "--", "/entrypoint.sh"]


    
 
